name: Actions
on: [push]

jobs:
  my-job:
    name: Action

    runs-on: ubuntu-latest

    steps:
      - name: preparation - checkout source
        uses: actions/checkout@v1

      - name: preparation - reading toolchain versions
        id: versions
        run: |
          echo "::set-output name=rust::$(cat rust-toolchain)"
          echo "::set-output name=node::$(cat .nvmrc)"

      - name: preparation - reading yarn cache path
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: caching - yarn
        uses: actions/cache@v1
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: caching - node_modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: ${{ runner.os }}-yarn-modules-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-modules-

      - name: caching - cargo registry
        uses: actions/cache@v1
        with:
          path: /usr/share/rust/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-key: ${{ runner.os }}-cargo-registry-

      - name: preparation - install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ steps.versions.outputs.rust }}

      - name: preparation - install node
        uses: actions/setup-node@v1
        with:
          node-version: ${{ steps.versions.outputs.node }}

      - name: run - yarn install
        run: yarn install

      - name: bot - code generation and formatting
        run: GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} yarn fix-and-commit

      - name: run - cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check

      - name: run - cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test

      - name: run - yarn test
        run: yarn test --passWithNoTests
