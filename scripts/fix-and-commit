#!/bin/bash
set -veuxo pipefail

if ! [[ -z "$(git status -s -uall)" ]]; then
    echo "error: index is already dirty"
    exit
fi

git remote add github "https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git"
git pull github ${GITHUB_REF} --ff-only

git add ./src

bash scripts/generate
bash scripts/format

if ! [[ -z "$(git status -s -uall)" ]]; then    
    git config user.name "bot"
    git config user.email "bot@jeremy.ca"
    git add .

    git commit -m "ðŸ¤–ðŸ”§ automatic fixes"

    git push github HEAD:${GITHUB_REF}

    git checkout HEAD~
else
    echo "no changes to commit"
fi
